load_module /usr/lib/nginx/modules/ngx_rtmp_module.so;

worker_processes auto;
worker_priority -10;  # Prioridade alta para processamento de streaming
error_log /var/log/nginx/error.log debug;
pid /var/run/nginx.pid;

# Ajustes de processamento em tempo real
timer_resolution 10ms;
worker_rlimit_nofile 100000;

events {
    worker_connections 4096;
    multi_accept on;
    use epoll;
}

include /etc/nginx/rtmp.conf;

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    access_log off;  # Desabilitamos logs para melhor performance
    
    # Otimizações extremas para latência
    tcp_nodelay on;
    tcp_nopush off;  # Desligado para transmissão imediata
    sendfile on;
    directio 512;
    aio on;
    
    # Reduzir keepalive para economizar recursos
    keepalive_timeout 15;
    keepalive_requests 1000;
    
    # Otimização de buffers para reduzir latência
    client_body_buffer_size 32k;
    client_max_body_size 100m;
    client_body_timeout 10;
    client_header_timeout 10;
    send_timeout 5;
    output_buffers 1 32k;
    postpone_output 0;
    
    # Configurações 100% permissivas para CORS
    add_header 'Access-Control-Allow-Origin' '*' always;
    add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE, PATCH, HEAD' always;
    add_header 'Access-Control-Allow-Headers' '*' always;
    add_header 'Access-Control-Expose-Headers' '*' always;
    add_header 'Access-Control-Allow-Credentials' 'true' always;
    add_header 'Access-Control-Max-Age' '1728000' always;

    server {
        listen 80;
        server_name localhost;
        
        # Para requisições OPTIONS, responde imediatamente com 200
        if ($request_method = 'OPTIONS') {
            return 200;
        }
        
        # Configurações HLS para streaming de baixa latência
        location /hls {
            types {
                application/vnd.apple.mpegurl m3u8;
                video/mp2t ts;
            }
            alias /tmp/hls;
            
            # Desabilitar cache completamente para streaming ao vivo
            add_header Cache-Control "no-cache, no-store, must-revalidate" always;
            add_header Pragma no-cache always;
            add_header Expires 0 always;
            
            # CORS extremamente permissivo
            add_header 'Access-Control-Allow-Origin' '*' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE, PATCH, HEAD' always;
            add_header 'Access-Control-Allow-Headers' '*' always;
            add_header 'Access-Control-Expose-Headers' '*' always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;
            
            # Permitir navegação de diretórios
            autoindex on;
            
            # Configurações para servir segmentos o mais rápido possível
            directio 512;
            directio_alignment 512;
            
            # Aumentar a prioridade de entrega
            limit_rate_after 0;
            limit_rate 0;
        }
        
        # DASH tem melhor latência que HLS em muitos navegadores
        location /dash {
            types {
                application/dash+xml mpd;
                video/mp4 mp4;
            }
            alias /tmp/dash;
            
            # Desabilitar cache completamente
            add_header Cache-Control "no-cache, no-store, must-revalidate" always;
            add_header Pragma no-cache always;
            add_header Expires 0 always;
            
            # CORS extremamente permissivo
            add_header 'Access-Control-Allow-Origin' '*' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE, PATCH, HEAD' always;
            add_header 'Access-Control-Allow-Headers' '*' always;
            add_header 'Access-Control-Expose-Headers' '*' always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;
            
            # Permitir navegação de diretórios
            autoindex on;
            
            # Configurações para servir segmentos o mais rápido possível
            directio 512;
            directio_alignment 512;
        }

        location /stat {
            rtmp_stat all;
            rtmp_stat_stylesheet stat.xsl;
        }

        location / {
            return 404;
        }
    }
} 